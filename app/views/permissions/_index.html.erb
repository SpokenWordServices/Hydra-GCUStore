<% unless defined?(asset_id) %>
  <% asset_id = params[:asset_id] %>
<% end %>
<form id="document_metadata" action="<%= url_for(:asset_id=>@document_fedora.pid,:action=>"update", :controller=>"permissions") %>" method="post" data-resourceType="hydrangea_article" accept-charset="utf-8">
  <fieldset class="edit-standard">
    <legend>Group Permissions</legend>
    <dl>
    <% choices = [{"No Access"=>"none"},{"Discover" => "discover"}, {"Read & Download" => "read"}, {"Edit & Upload" => "edit"}] %>
    <% roles = RoleMapper.role_names %>
    <%# This next line should be conditional upon a person having Publish permissions on the object's collection %>
    <% roles << "public" %>
	<% current_user_groups = RoleMapper.roles(current_user.login) %>
    <% roles.each do |role| %>
      <% addRole = true %>
		<%#
			-# Don't allow a user to change their own group permissions.
			-# Currently, just don't render the user's own  group permissions
			-# In the future, we should show current_user's permissions and just disable the ability to modify
		%>
      <% if (current_user_groups.include? role) %>
          <% if !(role == "public") %> 
            <% addRole = false %>
		  <% end %>
      <% end %>
	  <% if addRole == true %>
       <% role_permissions = @document_fedora.datastreams_in_memory["rightsMetadata"].permissions({"group"=>role}) %>
       <% field_name = "#{role}_group_access" %>
       <dt>
       	<label for="<%=h field_name %>">
         	<%= role.capitalize %>
	   	</label>
       </dt>
       <dd>
       <select id="<%=h field_name %>" name="permission[group][<%=h role %>]">
         <% choices.each do |choice| %>
          <% choice_label = choice.keys.first %>
          <% choice_name = choice.values.first %>
          <% if role_permissions == choice_name %>
            <option value="<%=h choice_name %>" selected="selected">
               <%= choice_label %>
            </option>
          <% else %>
            <option value="<%=h choice_name %>">
               <%= choice_label %>
            </option>
          <% end %>
        <% end %>
      </select>
      </dd>
     <% end %>
    <% end %>
	</dl> 
  </fieldset>
  <input type="hidden"  name="_method" value="put"/>
	<div>
	    <div class="form-control">
	      <%= submit_tag "Save permissions" %>
	    </div>
 	</div>
</form> 
